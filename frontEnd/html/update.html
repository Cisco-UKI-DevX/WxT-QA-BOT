<!DOCTYPE html>
<html>

<head>
    <title>Q&amp;A Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
    <link rel="stylesheet" href="css/update.css">
    <link rel="shortcut icon" href="./public/assets/favicon.ico" type="image/x-icon">
    <link rel="icon" href="./public/assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/autoComplete.css">
</head>

<body>

    <nav class="navbar primaryFont" role="navigation" aria-label="main navigation">
        <!--Left Side of the Navbar-->
        <div class="navbar-brand">
            <a class="navbar-item">
                <img class="logo" src="assets/meetingsLogo.png">
            </a>
            <a class="navbar-item is-size-4 ">
                April's Knowledge Base
            </a>
        </div>
        <!--Right Side fo the Navbar-->
        <div class="navbar-menu">
            <div class="navbar-end">
                <a class="navbar-item" href="https://www.cisco.com/">
                    <img class="logo" src="assets/ciscoLogo.png">
                </a>
                <a class="navbar-item" href="https://www.ibm.com/uk-en">
                    <img class="logo" src="assets/ibmLogo.png">
                </a>
            </div>
        </div>
    </nav>

    <div class="section primaryFont">
        <div class="tabs is-centered">
            <ul>
                <li><a href="main.html">Submit</a></li>
                <li class="is-active"><a href="update.html">Update</a></li>
                <!--Icon show page is locked-->
                <li id='pageLocked' class="tab-is-right"><a><span class='is-invisible'>.</span><i id='lockedIcon'
                            class="fas fa-lock "></i><i id='unlockedIcon' class="fas fa-unlock"
                            style='display: none;'></i><span class='is-invisible'>.</span></a></li>
            </ul>
        </div>
        <div class="columns">
            <div class="column is-three-quarters">
                <h3 class="is-size-4">Question</h3>
                <div id="questionGroup">
                    <div class="field">
                        <input required autocomplete="off" class="input questionInput" id="questionField" type="text"
                            placeholder="Enter a question">
                    </div>
                    <!--On submit of the form do the add entry, use target to prevent redirect (Sorry, should be done better)-->
                    <!--TODO: Remove the target and submit the form with ajax -->
                    <!-- <form id="question"> -->
                    <!--Question Input-->
                    <div class="field">
                        <div class="buttons has-addons is-right">
                            <button disabled class="button has-text-white" id="addQuestionFieldButton">
                                <span class="icon is-small">
                                    <i class="fas fa-plus"></i>
                                </span>
                            </button>
                            <button disabled class="button has-text-white" id="removeQuestionFieldButton">
                                <span class="icon is-small">
                                    <i class="fas fa-minus"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="column is-one-quarter">
                <div id='searchQuestionField' class="field has-addons">
                    <div class="control is-expanded ">
                        <input required class="input is-medium is-fullwidth" id="questionIDField" type="text"
                            placeholder="Question ID">
                    </div>
                    <div class="control">
                        <a id="searchQuestionButton" class="button is-medium has-text-white"><i
                                class="fas fa-search"></i></a>
                    </div>
                    
                    <button id="getAllQuestion" class="button is-medium has-text-white">View all</button>
                </div>
                
            </div>
        </div>
        <div class="columns">
            <div class="column is-three-quarters">
                <div class="to-hide">
                    <!-- Answer Input -->
                    <p class="is-size-4">Answer</p>
                    <div class="field">
                        <div class="control">
                            <textarea disabled required class="textarea" id="ans" name="answer"
                                placeholder="Answer will appear here."></textarea>
                        </div>
                    </div>
                    <!--Submit Line-->
                    <div class="field is-grouped">
                        <div class="field">
                            <div class="control">
                                <div class="select">
                                    <select disabled id='select' name="select" required>
                                        <option>General</option>
                                        <option>Volunteer Programme</option>
                                        <option>Plans and Pricing</option>
                                        <option>Controls & Features</option>
                                        <option>Quality Issues</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <div class="file has-name is-fullwidth">
                                <label class="file-label">
                                    <input disabled class="file-input" id="fileInput" type="file" name="resume">
                                    <span class="file-cta">
                                        <span class="file-icon">
                                            <i class="fas fa-upload"></i>
                                        </span>
                                        <span class="file-label">
                                            Choose a file
                                        </span>
                                    </span>
                                    <span class="file-name" id="fileName">
                                        No File Loaded
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div class="control is-pulled-right">
                            <button disabled onclick="deleteFile()" id='deleteFileButton'
                                class="button is-danger">Delete File</button>
                        </div>
                        <div class="control is-pulled-right">
                            <button disabled id="submitQA" class="button is-link">Submit</button>
                        </div>
                    </div>
                    <!-- </form> -->
                    <br><br>
                    <p class="is-size-4">Attached Files</p>
                    <a href="" target="_blank" id="linkButton" class="button has-text-white linkButton">No File
                        Attached</a>
                </div>
            </div>
            <div class="column is-one-quarter">
                <div class="markdown box to-hide">
                    <div class="container">
                        <h2 class="title is-5 has-text-white">Markdown Cheat Sheet</h2>
                        <p class="is-size-5 has-text-weight-semibold">Style</p>
                        <p class="has-text-white">**BOLD**</p>
                        <p class="has-text-white">_italic_</p>
                        <p class="has-text-white">> Blockquote</p>
                        <p class="has-text-white">`unformatted text`</p>
                        <br>
                        <p class="is-size-5 has-text-weight-semibold">Links</p>
                        <p class="has-text-white">Example: [Cisco Website](www.cisco.com)</p>
                        <br>
                        <p class="is-size-5 has-text-weight-semibold">Lists</p>
                        <p class="has-text-white">1. Item1</p>
                        <p class="has-text-white">2. Item2</p>
                        <p class="has-text-white">3. Item3</p>
                        <br>
                        <p class="has-text-white">* Bullet point1</p>
                        <p class="has-text-white">* Bullet point2</p>
                        <br>
                        <p class="is-size-5 has-text-weight-semibold">Headings</p>
                        <p class="has-text-white"># Heading 1</p>
                        <p class="has-text-white">## Heading 2</p>
                        <p class="has-text-white">### Heading 3</p>
                        <p class="has-text-white">--- Horizontal Line</p>
                    </div>
                </div>
                <button onclick="deleteEntry()" id='deleteEntryButton'
                    class="button is-danger is-fullwidth to-hide">Delete Question</button>
            </div>
        </div>
    </div>
    <!-- Markdown Preview Area -->
    <div class="markup-Container to-hide">
        <div class="section primaryFont">
            <p class="is-size-4 has-text-white has-text-weight-medium">Markdown Preview</p>
            <div id="answerField" class="markup-Area content"></div>
        </div>
    </div>

    <div class="modal" id="listModal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">All Questions</p>
                <button class="delete" id="closeQuestion" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <table class="table is-fullwidth">
                    <thead>
                        <tr>
                            <th>Number</th>
                            <th>Question</th>
                        </tr>
                    </thead>
                    <tbody id="anslist">
                        <!--List of answers pulled from the database-->
                    </tbody>
                </table>
            </section>
            <footer class="modal-card-foot">
            </footer>
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.0/showdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
<script>
    //true = Page Locked
    //false = Page Unlocked
    let lockedStatus = true;

    let lockedIcon = document.getElementById('pageLocked');

    lockedIcon.addEventListener('click', function () {
        if (lockedStatus == true) {

            let isLoggedIn = sessionStorage.getItem('token');
            if (isLoggedIn == null) {
                Swal.fire({
                    title: 'Not Logged In!',
                    text: "You need to log in to make changes.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: 'rgb(0, 188, 235)',
                    cancelButtonColor: 'rgb(251, 61, 102)',
                    confirmButtonText: 'Log In'
                }).then((result) => {
                    if (result.value) {
                        location.href = './login.html'
                    }
                })
            } else {
                lockedStatus = false
                $('#lockedIcon').toggle()
                $('#unlockedIcon').toggle('slow')
                toggleInputLock(lockedStatus);
            }


        } else {
            lockedStatus = true
            $('#lockedIcon').toggle('slow')
            $('#unlockedIcon').toggle()
            toggleInputLock(lockedStatus);
        }
    })


    //function to toggle input locked status
    function toggleInputLock(state) {
        //if the state is changing to unlocked
        if (state == false) {
            $('#addQuestionFieldButton').prop('disabled', false);
            $('#removeQuestionFieldButton').prop('disabled', false);
            $('#ans').prop('disabled', false);
            $('#select').prop('disabled', false);
            $('#fileInput').prop('disabled', false);
            $('#deleteFileButton').prop('disabled', false);
            $('#submitQA').prop('disabled', false);
            $('#deleteEntryButton').prop('disabled', false);

        } else { //if the state is changing to locked
            $('#addQuestionFieldButton').prop('disabled', true);
            $('#removeQuestionFieldButton').prop('disabled', true);
            $('#ans').prop('disabled', true);
            $('#select').prop('disabled', true);
            $('#fileInput').prop('disabled', true);
            $('#deleteFileButton').prop('disabled', true);
            $('#submitQA').prop('disabled', true);
            $('#deleteEntryButton').prop('disabled', true);
        }
    }

    //Search by ID
    document.getElementById("searchQuestionButton").addEventListener('click', function () {
        let questionID = document.getElementById("questionIDField").value;
        $(".to-hide").each(function (index) {
            $(this).attr("style", "display:block !important;");
        });
        populateFields(questionID);
    });

    //Called when the user presses the all questions button
    document.getElementById("getAllQuestion").addEventListener('click', function () {
        //activates the modal by adding the active class
        document.getElementById("listModal").classList.add("is-active");
    });
    //Called when the user closes the model with the x
    document.getElementById("closeQuestion").addEventListener('click', function () {
        //closes the modal by removing the active class
        document.getElementById("listModal").classList.remove("is-active");
    });

    //On page load load all the questions and put them in the modal
    axios.get('http://35.242.181.193:3002/getAll')
        .then(response => {
            //Loop through every q and a
            for (let i = 0; i < response.data.items.length; i++) {
                //build html with the response
                let appendedQuestion = "<tr><td>" + response.data.items[i].id + "</td><td>" + response.data.items[i]
                    .question + "</td></tr>";
                //import them into the modal
                document.getElementById("anslist").innerHTML += appendedQuestion;
            }
        });

    //File input 
    const fileInput = document.getElementById('fileInput');
    fileInput.onchange = () => {
        if (fileInput.files.length > 0) {
            const fileName = document.getElementById('fileName');
            fileName.textContent = fileInput.files[0].name;
            $('#deleteFileButton').removeAttr("disabled");
        }
    }

    //When a user types in the answer box call the preview function
    document.getElementById("ans").addEventListener("keyup", preview);

    //Generates markdown with showdown
    function preview() {
        //Import an instance of showdown
        var converter = new showdown.Converter();
        //Get the value of answer Field
        var text = document.getElementById('ans').value;
        //Convert the inputted text to HTML
        var html = converter.makeHtml(text);
        //set answerField to the updated html
        document.getElementById("answerField").innerHTML = html;
    };

    function generateQuestionFormat() {
        let listOfQuestions = document.getElementsByClassName('questionInput');
        let appendedQuestions = "";

        //loop through all the questions and generate the alternative questions 
        for (let i = 1; i < listOfQuestions.length; i++) {
            if (listOfQuestions.length - 1 == i) {
                appendedQuestions += listOfQuestions[i].value
            } else {
                appendedQuestions += listOfQuestions[i].value + " ; ";
            }
        }

        //If no alternative questions asked, return as "" as alternatives
        if (listOfQuestions.length == 1) {
            return ""
        }
        //returns the appended questions
        return appendedQuestions;
    }

    // Grab the forms id
    var form = document.getElementById('form');
    // Adds a listener for the "submit" event.
    // form.addEventListener('submit', function (e) {
    //     e.preventDefault();
    // });

    //On click of the submit button
    document.getElementById("submitQA").addEventListener('click', submitQA);

    function submitQA() {
        var url = "http://35.242.181.193:3002/updateEntries/" + document.getElementById('questionIDField').value

        var formdata = new FormData();
        formdata.append("question", document.getElementsByClassName('questionInput')[0].value);
        formdata.append("answer", document.getElementById('ans').value);
        formdata.append("tag", document.getElementById('select').value);
        formdata.append("alternatives", generateQuestionFormat());

        var requestOptions = {
            method: 'PUT',
            body: formdata,
            redirect: 'follow',
            mode: 'cors',
            headers: {
                "Authorization": 'Bearer ' + sessionStorage.getItem('token')
            }
        };

        fetch(url, requestOptions)
            .then(response => response.text())
            .then(result => {

                //grab file from input using jquery because js didnt work for some reason 
                var uploadedFile = $('#fileInput').prop('files')[0];

                //check if a file as been inputted 
                if (uploadedFile !== undefined) {
                    //check if a file has been deleted
                    if (uploadedFile !== "") {
                        //build a form
                        var fileformdata = new FormData();
                        //add the file into the form
                        fileformdata.append("file", uploadedFile);

                        //build request options
                        var fileRequestOptions = {
                            method: 'POST',
                            body: fileformdata,
                            redirect: 'follow',
                            mode: 'cors',
                            headers: {
                                "Authorization": 'Bearer ' + sessionStorage.getItem('token')
                            }
                        };
                        //Send an API call to the url with the ID
                        return fetch("http://35.242.181.193:3002/uploadFile/" + result, fileRequestOptions);
                    }
                }
            })
            .catch(error => {
                if (error.status === 401) {
                    location.href = "login.html"
                }
                if (error.status === 400) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Bad Request',
                    })
                }
            })
            .then(function () {
                Swal.fire(
                    'Thank you',
                    'Submitted successfully',
                    'success'
                )
            })

    }

    //If add is clicked append a new input box to the page
    document.getElementById("addQuestionFieldButton").addEventListener('click', function () {
        $("#questionGroup").append(
            '<div class="field altQuestionInput"><input class="input questionInput" type="text" placeholder="Alternative Question"></div>'
        );
        let currentHeight = $(".markdown").height()
        $(".markdown").height(currentHeight + 52)
    })

    //If remove is clicked remove a input box unless theres only 1
    document.getElementById("removeQuestionFieldButton").addEventListener('click', function () {
        var questionInputs = document.getElementsByClassName('questionInput');

        if (questionInputs.length > 1) {
            questionInputs[questionInputs.length - 1].remove();

            let currentHeight = $(".markdown").height()
            $(".markdown").height(currentHeight - 52)
        } else {
            alert("You must provide atleast one question.")
        }
    })



    //reset all the fields to null
    function resetFields() {
        //set question field to null
        document.getElementById("questionField").value = null;

        //set answer field to null
        document.getElementById("ans").value = null;

        //remove all alternative question input boxes
        var elements = document.getElementsByClassName('altQuestionInput');
        while (elements.length > 0) {
            //delete each input box
            elements[0].parentNode.removeChild(elements[0]);
        }


    }

    function deleteFile() {
        //get the file input and set value to undefined so it doesnt get uploaded
        document.getElementById('fileInput').value = "";
        document.getElementById('fileName').textContent = "No File Selected"
        $('#deleteFileButton').attr("disabled", true);

    }

    function deleteEntry() {
        var qid = document.getElementById('questionIDField').value;
        Swal.fire({
            title: 'Are you sure you want to delete question ' + qid + '?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.value) {
                var url = "http://35.242.181.193:3002/deleteQuestion/" + qid;

                var requestOptions = {
                    method: 'DELETE',
                    redirect: 'follow',
                    mode: 'cors',
                    headers: {
                        "Authorization": 'Bearer ' + sessionStorage.getItem('token')
                    }
                };

                fetch(url, requestOptions)
                    .then(response => response.text())
                    .then(result => {
                        Swal.fire(
                            'Deleted!',
                            'Question ' + qid + ' has been deleted!',
                            'success'
                        )
                    })
                    .catch(error => {
                        if (error.status === 500) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Internal Server Error',
                            })
                        }
                        if (error.status === 400) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Bad Request',
                            })
                        }
                    })
            }
        })
    }

    function getAllQuestions() {
        var url = "http://35.242.181.193:3002/getAllQuestions";

        var requestOptions = {
            method: 'GET',
            redirect: 'follow',
            mode: 'cors',
            headers: {
                "Authorization": 'Bearer ' + sessionStorage.getItem('token')
            }
        };

        return fetch(url, requestOptions)
            .then(response => response.text())
            .then(result => result)
            .catch(error => {
                if (error.status === 401) {
                    location.href = "login.html"
                }
                if (error.status === 400) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Bad Request',
                    })
                }
            })
    }

    function populateFields(questionID) {
        //Get request the question ID 
        axios.get('http://35.242.181.193:3002/getKnowledge/' + questionID)
            .then(response => {
                //Update the question field on the page with the question queried
                document.getElementById("questionField").value = response.data.question;
                //Update the answer field on the page with the question queried
                document.getElementById("ans").value = response.data.answer;
                //Update the question type
                // document.getElementById("type").textContent = response.data.tag;
                //Toggles button on the page
                if (response.data.location != null) {
                    document.getElementById("linkButton").href = response.data.location;
                    document.getElementById("linkButton").classList.remove("linkButton");
                    document.getElementById("linkButton").textContent = "File Loaded - Open File"
                } else {
                    document.getElementById("linkButton").classList.add("linkButton");
                    document.getElementById("linkButton").textContent = "No Files"
                }

                var converter = new showdown.Converter();
                //Get the value of answer Field
                var text = response.data.answer;
                //Convert the inputted text to HTML
                var html = converter.makeHtml(text);
                //set answerField to the updated html
                document.getElementById("answerField").innerHTML = html;

                document.getElementById("questionIDField").value = questionID;

                //clear the alt question field 
                document.getElementById("altQuestionField").value = "";

                //prints the alt questions at the bottom of the page
                for (let i = 0; i < response.data.alternatives.length; i++) {
                    $("#questionGroup").append(
                        '<div class="field altQuestionInput"><input class="input questionInput" type="text" placeholder="Alternative Question" value="' +
                        response.data.alternatives[i] + '"></div>'
                    );
                }
            }).catch(error => {
                if (error.status === 401) {
                    location.href = "login.html"
                }
                if (error.status === 400) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Bad Request',
                    })
                }
            })
    }

    var options = getAllQuestions().then(out => {
        return JSON.parse(out)
    });

    new autoComplete({
        data: {
            src: options,
            key: ["question"],
            cache: false
        },
        placeHolder: "Enter a question",
        selector: "#questionField",
        threshold: 0,
        debounce: 300,
        searchEngine: "strict",
        resultsList: {
            render: true,
            container: source => {
                source.setAttribute("id", "question_list");
            },
            destination: document.querySelector("#questionField"),
            position: "afterend",
            element: "ul"
        },
        maxResults: 5,
        highlight: true,
        resultItem: {
            content: (data, source) => {
                source.innerHTML = data.match;
            },
            element: "li"
        },
        noResults: () => {
            const result = document.createElement("li");
            result.setAttribute("class", "no_result");
            result.setAttribute("tabindex", "1");
            result.innerHTML = "No Results";
            document.querySelector("#autoComplete_list").appendChild(result);
        },
        onSelection: feedback => {
            $("#questionField").val(feedback.selection.value.question);
            $(".to-hide").each(function (index) {
                $(this).attr("style", "display:block !important;");
            });
            populateFields(feedback.selection.value.id);
        }
    });



    // Get the input field
var input = document.getElementById("questionIDField");

// Execute a function when the user releases a key on the keyboard
input.addEventListener("keyup", function(event) {
  // Number 13 is the "Enter" key on the keyboard
  if (event.keyCode === 13) {
    // Cancel the default action, if needed
    event.preventDefault();
    // Trigger the button element with a click
    document.getElementById("searchQuestionButton").click();
  }
});
</script>

</html>