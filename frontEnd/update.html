<!DOCTYPE html>
<html>

<head>
    <title>Q&amp;A Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
    <link rel="stylesheet" href="css/update.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>

<body>

    <nav class="navbar primaryFont" role="navigation" aria-label="main navigation">
        <!--Left Side of the Navbar-->
        <div class="navbar-brand">
            <a class="navbar-item">
                <img class="logo" src="assets/meetingsLogo.png">
            </a>
            <a class="navbar-item is-size-4 ">
                Q&A Dashboard
            </a>
        </div>
        <!--Right Side fo the Navbar-->
        <div class="navbar-menu">
            <div class="navbar-end">
                <a class="navbar-item" href="https://www.cisco.com/">
                    <img class="logo" src="assets/ciscoLogo.png">
                </a>
                <a class="navbar-item" href="https://www.ibm.com/uk-en">
                    <img class="logo" src="assets/ibmLogo.png">
                </a>
            </div>
        </div>
    </nav>

    <div class="section primaryFont">
        <div class="tabs is-centered">
            <ul>
                <li><a href="main.html">Submit</a></li>
                <li><a href="query.html">Query</a></li>
                <li class="is-active"><a href="update.html">Update</a></li>
            </ul>
        </div>
        <h3 class="is-size-4">Question</h3>
        <div class="columns">
            <div class="column is-three-quarters">
                <!--On submit of the form do the add entry, use target to prevent redirect (Sorry, should be done better)-->
                <!--TODO: Remove the target and submit the form with ajax -->
                <form id="form">
                    <!--Question Input-->

                    <div id="questionGroup">
                        <div class="field">
                            <input required class="input questionInput" id="questionField" type="text"
                                placeholder="Question"></div>
                    </div>
                    <div class="field">
                        <div class="buttons has-addons is-right">
                            <button class="button has-text-white" id="addQuestionFieldButton">
                                <span class="icon is-small">
                                    <i class="fas fa-plus"></i>
                                </span>
                            </button>
                            <button class="button has-text-white" id="removeQuestionFieldButton">
                                <span class="icon is-small">
                                    <i class="fas fa-minus"></i>
                                </span>
                            </button>
                        </div>
                    </div>

                    <!-- Answer Input -->
                    <p class="is-size-4">Answer</p>
                    <div class="field">
                        <div class="control">
                            <textarea required class="textarea" id="ans" name="answer"
                                placeholder="It logs on."></textarea>
                        </div>
                    </div>
                    <!--Submit Line-->
                    <div class="field is-grouped">
                        <div class="field">
                            <div class="control">
                                <div class="select">
                                    <select id='select' name="select" required>
                                        <option>General</option>
                                        <option>Volunteer Programme</option>
                                        <option>Plans and Pricing</option>
                                        <option>Controls & Features</option>
                                        <option>Quality Issues</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <div class="file is-white">
                                <label class="file-label">
                                    <input class="file-input" type="file" name="resume">
                                    <span class="file-cta">
                                        <span class="file-icon">
                                            <i class="fas fa-file-upload"></i>
                                        </span>
                                        <span name="file" class="file-label">
                                            Attach File
                                        </span>
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div class="control is-pulled-right">
                            <button id="submitQA" class="button is-link">Submit</button>
                        </div>
                </form>
            </div>
        </div>
        <div class="column">
            <div class="searchBox box">
                <div class="container">
                    <h2 class="is-size-4">Select a question</h2>
                    <div class="field has-addons">
                        <div class="control is-expanded"">
                            <input class=" input" id="questionIDField" type="text" placeholder="Question ID">
                        </div>
                        <div class="control">
                            <a id="searchQuestionButton" class="button is-info">
                                Find
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="markdown box">
                <div class="container">
                    <h2 class="title is-5 has-text-white">Markdown Cheat Sheet</h2>
                    <p class="has-text-white">Add special characters around your text to apply markup formatting</p>
                    <br>
                    <p class="is-size-5 has-text-weight-semibold">Style</p>
                    <p class="has-text-white">**BOLD**</p>
                    <p class="has-text-white">_italic_</p>
                    <p class="has-text-white">>Blockquote</p>
                    <br>
                    <p class="is-size-5 has-text-weight-semibold">Lists</p>
                    <p class="has-text-white">1. Item1</p>
                    <p class="has-text-white">2. Item2</p>
                    <p class="has-text-white">3. Item3</p>
                    <br>
                    <p class="has-text-white">*Bullet point1</p>
                    <p class="has-text-white">*Bullet point2</p>
                    <br>
                    <p class="is-size-5 has-text-weight-semibold">Headings</p>
                    <p class="has-text-white"># Heading 1</p>
                    <p class="has-text-white"># # Heading 2</p>
                    <p class="has-text-white"># # # Heading 3</p>
                    <p class="has-text-white">--- Horizonal Line</p>
                    <br>
                    <p class="is-size-5 has-text-weight-semibold">Links</p>
                    <p class="has-text-white">[link text](link)</p>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!-- Live Preview Area -->
    <div class="markup-Container">

        <div class="section primaryFont">

            <p class="is-size-4 has-text-white has-text-weight-medium">Live Preview</p>
            <div id="answerField" class="markup-Area content">

            </div>
        </div>
    </div>
    <iframe style="display: none;" width="0" height="0" border="0" name="dummyframe" id="dummyframe"></iframe>
</body>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.0/showdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>
    //When a user types in the answer box call the preview function
    document.getElementById("ans").addEventListener("keyup", preview);

    //Generates markdown with showdown
    function preview() {
        //Import an instance of showdown
        var converter = new showdown.Converter();
        //Get the value of answer Field
        var text = document.getElementById('ans').value;
        //Convert the inputted text to HTML
        var html = converter.makeHtml(text);
        //set answerField to the updated html
        document.getElementById("answerField").innerHTML = html;
    };

    function generateQuestionFormat() {
        let listOfQuestions = document.getElementsByClassName('questionInput');
        let appendedQuestions = "";

        //loop through all the questions and generate the alternative questions 
        for (let i = 1; i < listOfQuestions.length; i++) {
            if (listOfQuestions.length - 1 == i) {
                appendedQuestions += listOfQuestions[i].value
            } else {
                appendedQuestions += listOfQuestions[i].value + " ; ";
            }
        }

        //If no alternative questions asked, return as "" as alternatives
        if (listOfQuestions.length == 1) {
            return ""
        }
        //returns the appended questions
        return appendedQuestions;
    }

    // Grab the forms id
    var form = document.getElementById('form');
    // Adds a listener for the "submit" event.
    form.addEventListener('submit', function (e) {
        e.preventDefault();
    });

    //On click of the submit button
    document.getElementById("submitQA").addEventListener('click', submitQA);
    function submitQA() {
        var url = "http://35.242.181.193:3003/updateEntries/" + document.getElementById('questionIDField').value

        var formdata = new FormData();
        formdata.append("question", document.getElementsByClassName('questionInput')[0].value);
        formdata.append("answer", document.getElementById('ans').value);
        formdata.append("tag", document.getElementById('select').value);
        formdata.append("alternatives", generateQuestionFormat());

        var requestOptions = {
            method: 'PUT',
            body: formdata,
            redirect: 'follow',
            mode: 'cors'
        };

        fetch(url, requestOptions)
            .then(response => response.text())
            .then(result => console.log(result))
            .then(
                Swal.fire(
                    'Thank you',
                    'Submitted successfully',
                    'success'
                )
            )
            .catch(error => console.log('error', error));
    }

    //If add is clicked append a new input box to the page
    document.getElementById("addQuestionFieldButton").addEventListener('click', function () {
        $("#questionGroup").append('<div class="field altQuestionInput"><input class="input questionInput" type="text" placeholder="Alternate Question"></div>');
        let currentHeight = $(".markdown").height()
        $(".markdown").height(currentHeight + 52)
    })

    //If remove is clicked remove a input box unless theres only 1
    document.getElementById("removeQuestionFieldButton").addEventListener('click', function () {
        var questionInputs = document.getElementsByClassName('questionInput');

        if (questionInputs.length > 1) {
            questionInputs[questionInputs.length - 1].remove();

            let currentHeight = $(".markdown").height()
            $(".markdown").height(currentHeight - 52)
        } else {
            alert("You must provide atleast one question.")
        }

        
    })

    //Called when use searches a question ID
    document.getElementById("searchQuestionButton").addEventListener('click', function () {
        //Grab the question ID num
        let questionID = document.getElementById("questionIDField").value;
        //Get request the Question Num for details
        axios.get('http://35.242.181.193:3003/getKnowledge/' + questionID)
            .then(response => {
                //remove all alternative question fields and reset questions
                resetFields();

                //Update the alternate question fields on the page with the question queried
                //Have to do this first or it wipes the other fields
                for (let i = 0; i < response.data.alternatives.length; i++) {
                    $( "#questionGroup" ).append( '<div class="field altQuestionInput"><input value=' + response.data.alternatives[0] +
                        ' class="input questionInput" type="text" placeholder="Alternate Question"></div>' );
                }

                //update the value of the question field
                document.getElementById("questionField").value = response.data.question;

                //Update the answer field on the page with the question queried
                document.getElementById("ans").value = response.data.answer;

                //Update the question type
                document.getElementById("select").value= response.data.tag;

                //send the answer for rendering
                preview();
            })
    });

    //reset all the fields to null
    function resetFields() {
        //set question field to null
        document.getElementById("questionField").value = null;

        //set answer field to null
        document.getElementById("ans").value = null;

        //remove all alternative question input boxes
        var elements = document.getElementsByClassName('altQuestionInput');
        while (elements.length > 0) {
            //delete each input box
            elements[0].parentNode.removeChild(elements[0]);
        }


    }
</script>

</html>