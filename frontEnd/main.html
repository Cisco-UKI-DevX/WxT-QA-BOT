<!DOCTYPE html>
<html>

<head>
    <title>Q&amp;A Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>

<body>

    <nav class="navbar primaryFont" role="navigation" aria-label="main navigation">
        <!--Left Side of the Navbar-->
        <div class="navbar-brand">
            <a class="navbar-item">
                <img class="logo" src="assets/meetingsLogo.png">
            </a>
            <a class="navbar-item is-size-4 ">
                Q&A Dashboard
            </a>
        </div>
        <!--Right Side fo the Navbar-->
        <div class="navbar-menu">
            <div class="navbar-end">
                <a class="navbar-item" href="https://www.cisco.com/">
                    <img class="logo" src="assets/ciscoLogo.png">
                </a>
                <a class="navbar-item" href="https://www.ibm.com/uk-en">
                    <img class="logo" src="assets/ibmLogo.png">
                </a>
            </div>
        </div>
    </nav>

    <div class="section primaryFont">
        <div class="tabs is-centered">
            <ul>
                <li class="is-active"><a href="main.html">Submit</a></li>
                <li><a href="query.html">Query</a></li>
                <li><a href="update.html">Update</a></li>
            </ul>
        </div>
        <h3 class="is-size-4">Question</h3>
        <div class="columns">
            <div class="column is-three-quarters">
                <!--On submit of the form do the add entry, use target to prevent redirect (Sorry, should be done better)-->
                <!--TODO: Remove the target and submit the form with ajax -->
                <form id="form">
                    <!--Question Input-->

                    <div id="questionGroup">
                        <div class="field">
                            <input required class="input questionInput" type="text" placeholder="Question"></div>
                    </div>
                    <div class="field">
                        <div class="buttons has-addons is-right">
                            <button class="button has-text-white" id="addQuestionFieldButton">
                                <span class="icon is-small">
                                    <i class="fas fa-plus"></i>
                                </span>
                            </button>
                            <button class="button has-text-white" id="removeQuestionFieldButton">
                                <span class="icon is-small">
                                    <i class="fas fa-minus"></i>
                                </span>
                            </button>
                        </div>
                    </div>

                    <!-- Answer Input -->
                    <p class="is-size-4">Answer</p>
                    <div class="field">
                        <div class="control">
                            <textarea required class="textarea" id="ans" name="answer"
                                placeholder="It logs on."></textarea>
                        </div>
                    </div>
                    <!--Submit Line-->
                    <div class="field is-grouped">
                        <div class="field">
                            <div class="control">
                                <div class="select">
                                    <select id='select' name="select" required>
                                        <option>General</option>
                                        <option>Volunteer Programme</option>
                                        <option>Plans and Pricing</option>
                                        <option>Controls & Features</option>
                                        <option>Quality Issues</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <div class="file has-name is-fullwidth">
                                <label class="file-label">
                                    <input class="file-input" id="fileInput" type="file" name="resume">
                                    <span class="file-cta">
                                        <span class="file-icon">
                                            <i class="fas fa-upload"></i>
                                        </span>
                                        <span class="file-label">
                                            Choose a file...
                                        </span>
                                    </span>
                                    <span class="file-name" id="fileName">
                                        No File Selected
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div class="control is-pulled-right">
                            <button id="submitQA" class="button is-link">Submit</button>
                        </div>
                </form>
            </div>
        </div>
        <div class="column">
            <div class="markdown box">
                <div class="container">
                    <h2 class="title is-5 has-text-white">Markdown Cheat Sheet</h2>
                    <p class="has-text-white">Add special characters around your text to apply markup formatting</p>
                    <br>
                    <p class="is-size-5 has-text-weight-semibold">Style</p>
                    <p class="has-text-white">**BOLD**</p>
                    <p class="has-text-white">_italic_</p>
                    <p class="has-text-white">>Blockquote</p>
                    <br>
                    <p class="is-size-5 has-text-weight-semibold">Lists</p>
                    <p class="has-text-white">1. Item1</p>
                    <p class="has-text-white">2. Item2</p>
                    <p class="has-text-white">3. Item3</p>
                    <br>
                    <p class="has-text-white">*Bullet point1</p>
                    <p class="has-text-white">*Bullet point2</p>
                    <br>
                    <p class="is-size-5 has-text-weight-semibold">Headings</p>
                    <p class="has-text-white"># Heading 1</p>
                    <p class="has-text-white"># # Heading 2</p>
                    <p class="has-text-white"># # # Heading 3</p>
                    <p class="has-text-white">--- Horizonal Line</p>
                    <br>
                    <p class="is-size-5 has-text-weight-semibold">Links</p>
                    <p class="has-text-white">[link text](link)</p>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!-- Live Preview Area -->
    <div class="markup-Container">

        <div class="section primaryFont">

            <p class="is-size-4 has-text-white has-text-weight-medium">Live Preview</p>
            <div id="answerField" class="markup-Area content">

            </div>
        </div>
    </div>
    <iframe style="display: none;" width="0" height="0" border="0" name="dummyframe" id="dummyframe"></iframe>
</body>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.0/showdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>

    //grab the file input 
    const fileInput = document.getElementById('fileInput');
    //when the file input changes
    fileInput.onchange = () => {
        if (fileInput.files.length > 0) {
            //get the file name field
            const fileName = document.getElementById('fileName');
            //update the file name field
            fileName.textContent = fileInput.files[0].name;
        }
    }

    //When a user types in the answer box call the preview function
    document.getElementById("ans").addEventListener("keyup", preview);

    //Generates markdown with showdown
    function preview() {
        //Import an instance of showdown
        var converter = new showdown.Converter();
        //Get the value of answer Field
        var text = document.getElementById('ans').value;
        //Convert the inputted text to HTML
        var html = converter.makeHtml(text);
        //set answerField to the updated html
        document.getElementById("answerField").innerHTML = html;
    };

    function generateQuestionFormat() {
        let listOfQuestions = document.getElementsByClassName('questionInput');
        let appendedQuestions = "";

        //loop through all the questions and generate the alternative questions 
        for (let i = 1; i < listOfQuestions.length; i++) {
            if (listOfQuestions.length - 1 == i) {
                appendedQuestions += listOfQuestions[i].value
            } else {
                appendedQuestions += listOfQuestions[i].value + " ; ";
            }
        }

        //If no alternative questions asked, return as "" as alternatives
        if (listOfQuestions.length == 1) {
            return ""
        }
        //returns the appended questions
        return appendedQuestions;
    }

    // Grab the forms id
    var form = document.getElementById('form');
    // Adds a listener for the "submit" event.
    form.addEventListener('submit', function (e) {
        e.preventDefault();
    });

    //On click of the submit button
    document.getElementById("submitQA").addEventListener('click', submitQA);
    //
    function submitQA() {
        //create a form for the updated QA
        var formdata = new FormData();
        //fill in the form details with the input values
        formdata.append("question", document.getElementsByClassName('questionInput')[0].value);
        formdata.append("answer", document.getElementById('ans').value);
        formdata.append("tag", document.getElementById('select').value);
        formdata.append("alternatives", generateQuestionFormat());
        //set the requests settings
        var requestOptions = {
            method: 'POST',
            body: formdata,
            redirect: 'follow',
            mode: 'cors'
        };
        //Execute POST
        fetch("http://35.242.181.193:3003/addEntry", requestOptions)
            .then(response => {
                if (response.ok) {
                    return response.text()
                } else {
                    return Promise.reject(response);
                }
            })
            .then(result => {
                //grab file from input using jquery because js didnt work for some reason 
                var uploadedFile = $('#fileInput').prop('files')[0];
                //build a form
                var fileformdata = new FormData();
                //add the file into the form
                fileformdata.append("file", uploadedFile);

                //build request options
                var fileRequestOptions = {
                    method: 'POST',
                    body: fileformdata,
                    redirect: 'follow',
                    mode: 'cors'
                };

                //Send an API call to the url with the ID
                fetch("http://35.242.181.193:3003/uploadFile/" + result, fileRequestOptions);

            })
            .then(response => {
                //fire a successful
                //TODO: Check if actually successful
                Swal.fire(
                    'Thank you',
                    'Submitted successfully',
                    'success'
                )
            })
            .catch(error => console.log('error', error));
    }

    //If add is clicked append a new input box to the page
    document.getElementById("addQuestionFieldButton").addEventListener('click', function () {
        $("#questionGroup").append(
            '<div class="field altQuestionInput"><input class="input questionInput" type="text" placeholder="Alternate Question"></div>'
        );
    })

    //If remove is clicked remove a input box unless theres only 1
    document.getElementById("removeQuestionFieldButton").addEventListener('click', function () {
        var questionInputs = document.getElementsByClassName('questionInput');

        if (questionInputs.length > 1) {
            questionInputs[questionInputs.length - 1].remove();
        } else {
            alert("You must provide atleast one question.")
        }
    })
</script>

</html>